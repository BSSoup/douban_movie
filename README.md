# douban_movie
电影下载机器人

功能说明：本程序支持在指定系列豆瓣用户的想看电影页爬取指定加入想看的日期内的电影，然后检查个人Emby电影库中的资源，对不在电影库中的电影，到指定网站去检索，能找到资源后按照自定义顺序和选择偏好提取资源下载链接，然后用transmission软件去下载，然后通过微信的pushplus推送信息到微信上。程序当前为个人使用，基于个人环境搭建，不保证在其他环境可以运行。

使用条件：
1. 豆瓣账号；
2. Emby本地影视库，且影视库元数据信息需要准确；
3. 支持selenium的本地可调用chrome浏览器及驱动webdriver，如在群晖中运行可以在docker中安装selenium-chrome镜像；
4. python3环境及对应依赖库
5. transmission（程序是基于群晖中transmission的调用地址/端口运行）
6. push plus账号推送信息

使用方法：
2.设置方法介绍
2.1.环境
python写的，所以运行的基础就是需要python环境，我试过在win电脑/树莓派/群晖自带的pyhton3.5/和docker里面的青龙面板里面跑，最终选择了青龙，因为本身在薅京东羊毛，顺便就丢里面跑了，设置调整起来也方便。
python基础的依赖就不说了，需要说明的就是selenium的依赖，有些环境随便装，有些环境只能装3.14.1版本，需要自己尝试，如果直接装最新版不行，就选择装3.14.12版本吧。
下面我就用基于群晖docker+青龙的配置做下说明。
docker中青龙的按照配置也不做说明了，大家可以随便搜索，很多教程。
2.2. selenium需求的准备
写爬虫的时候为了比较容易规避各网站的反爬虫，选择了selenium，因为selenium是要基于浏览器和驱动去运行的，在群晖中又没有自带浏览器（在win或者树莓派之类的环境就不用担心这个），所以需要在docker 中安装selenium_chrome的镜像。
打开docker，在注册表搜索selenium
选择docker-seleniumdocker-selenium
这里选择selenium/standalone-chrome即可（其他chrome的版本也不是不可以比如debug版的，但是我们没这个需求），下载直接安装（安装过程端口自定义或者不设置均可，如果python不再docker里面运行，就建议自己指定端口，因为我们这里是计划在docker里面的青龙里运行的，所以无所谓）。
2.3.青龙面板
青龙面板的安装方法这里就不多解释了，作为狗东羊毛党很多人都已经装了。如果没有的网上也有很多教程，就不再赘述，大家可以百度（雾）bing一下，就能找到。
python的依赖需要在青龙里面安装，可选择进入青龙管理页面——依赖管理——python3——新建依赖，也可以选择在docker里面打开青龙详细页面——终端机——新增里面用pip的命令方式安装。这里至少需要安装的依赖有如下几个：bs4，selenium（如果最新版装不上就装3.14.1版本，方法为 pip install selenium==3.14.1）,transmissionrpc。
然后在青龙管理页面——脚本管理——新建，自己定义一个文件名字.py（这里命名要加上.py作为后缀，记住这个文件名），确认后，将代码复制进去，保存。
2.4.emby
绍emby这里的设置 ，是需要新建一个api的访问key。
然后根据api访问端口，信息获取端口
电影：http://地址:端口/emby/users/user代码/Items?Recursive=true&IncludeItemTypes=Movie&api_key=xxxxxxxx
电视剧：http://地址:端口/emby/users/user代码/Items?Recursive=true&IncludeItemTypes=Episode&api_key=xxxxxxxx
这里地址和端口就不说了，大家根据自己的实际情况去填写，然后user代码这个，可以自己从群晖正常登录emby后在浏览器链接里面去寻找serverId=后面的代码或者登录http://地址:端口/emby/System/Info?api_key=xxxxx 后在打开页面看最后显示的ID字段里面的代码
然后把key=后面的xxx换成自己的key就行了。
2.5. 设置
回到青龙管理页面——脚本管理，打开刚才新建的那个脚本，点击编辑，下啦找到如下一段内容，按照提示对内容进行填写
如果群晖没有按照transmission的话，需要先安装这个套件，然后记住其地址和设置的用户名以及密码
如果要接受微信推送，还需要去push plus注册一个账号pushplus(推送加)-微信消息推送平台，访问后点击登录，扫码注册，选择一对多推送，新建群组，然后后面设置会输入自己的token和群组代码（这里程序写的是一对多推送的情况，因为通常家庭用户不止一个人）
 **************************************************************************************************************
# 基础信息设置(以下信息需要在运行前手动设置）
# 设置豆瓣账号信息
users = ["user1", "user2"]  ，#填写豆瓣的id，多个账号请用逗号分隔，（只有一个账号只有一个账号的话users = ["user1"]，两个的话users = ["user1", "user2"]  ，多个和依次类推）
wish_time = 5 # 设置想要的检索日期天数(day)，比如今天是2022.4.16，设置5天的话，2022.4.11之前加入想看的就不会被检索了。
# 设置Emby库信息
embykey = "xxxxx"   #设置emby库的key信息,如之前未设置需要去emby管理页面设置新增
emby_address="http://地址:端口/emby/users/user代码/Items?Recursive=true&IncludeItemTypes="  #此处地址可以设置内网地址也可以设置外网地址，内网地址则只能在内网访问和运行，端口设置时候要把上面这一段包含地址/端口/user代码等的全填进去
# 设置音丝范资源清晰度检索顺序,运行时候会按清晰度顺序检索,冒号后面的值表示下载时候会选取该清晰度下最接近该数字的资源大小（GB）下载
check_order = {"4K": 20, "蓝光原盘": 20, "蓝光高清": 10, "WEB-DL": 10}
# 定义transmission的访问信息
tr_address = 'xxxxxx' #设置Tr的调用地址
tr_port = 9091  #设置Tr的调用端口，通常为9091，不是则改掉
tr_user = 'xxx'  #设置tr的登录用户名
tr_password = 'xxxxxx' #设置Tr的登录密码
out_path = r'/volumeUSB1/usbshare/torrents'  # 下临时种子载保存地址（已经取消种子下载方式，设置无效，可不管）
#设置微信推送端口信息
push_token="xxxxxxxxxxxx" #设置push-plus的群组或个人token
push_title="xxxxxxxxx"   #设置推送时候显示的标题名称
push_topic="xxxxxxxx"   #群组推送时需要设置，设置对应的群组名称，如果只推送给个人无需设置
 **************************************************************************************************************
以上填写完成后，点击保存
回到青龙面板管理页面——定时任务，然后新建定时任务，
保存，可以点击试运行一下。正常的话就OK了。
什么，如果不正常，那就看日志记录是啥问题，再去针对性解决了。
说明：
1. 源代码写的是资源搜索逻辑是片源网——音丝范——grab4k，但是第一个站点是需要账号密码的，这里写的是用cookie去登录，好像现在已经关闭注册了，所以如果没有账号密码就只有2个站点了，大家有好的资源站也可以分享下，后面慢慢增加进去。
2. 这里selenium—chrome是在docker里面的，所以程序已经把默认调用地址设置为localhost：4444了，如果不是，需要到程序里手动改。
3. 片源网的账号如果自己有，就bing一下如何获取cookie，我的方法是自己写了几行代码模拟运行，然后当猴硐登录后程序保存cookie，再把cookie文件复制到青龙里面和新建的douban_movie.py目录下。其他方法暂时没有尝试。
